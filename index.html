<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teman Ngobrol AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Custom scrollbar for a sleeker look */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }

        #chat-window::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
        }

        #chat-window::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .chat-bubble-bot,
        .chat-bubble-user {
            animation: slideInUp 0.5s ease-in-out;
        }

        #confirmation-modal {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-rose-100 via-purple-200 to-sky-200">

    <div class="flex flex-col h-screen max-w-2xl mx-auto p-4">
        <!-- Header -->
        <header class="text-center py-4 relative">
            <h1 class="text-3xl font-bold text-gray-800">Teman Ngobrol Kamu ðŸ’–</h1>
            <p class="text-gray-600 mt-1">Siap mendengarkan ceritamu kapan saja.</p>
            <button id="clear-button" title="Bersihkan riwayat"
                class="absolute top-1/2 -translate-y-1/2 right-0 text-xs bg-white/50 backdrop-blur-sm text-gray-600 hover:bg-red-500 hover:text-white font-semibold py-2 px-4 rounded-full transition-all duration-300">
                Bersihkan
            </button>
        </header>

        <!-- Chat Window -->
        <main id="chat-window"
            class="flex-1 overflow-y-auto p-4 space-y-6 bg-black bg-opacity-10 rounded-2xl shadow-inner backdrop-blur-sm">
            <!-- Chat history will be loaded here -->
        </main>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden flex items-center justify-center p-4">
            <div class="flex items-center space-x-2 text-gray-600">
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                <span class="text-sm">Sedang mengetik...</span>
            </div>
        </div>

        <!-- Input Form -->
        <footer class="py-4">
            <div class="flex items-center bg-white rounded-xl shadow-lg p-2">
                <input type="text" id="message-input" class="w-full p-3 text-gray-700 bg-transparent focus:outline-none"
                    placeholder="Ketik pesanmu di sini...">
                <button id="send-button"
                    class="ml-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg p-3 hover:opacity-90 transition-opacity duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-send">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 shadow-xl text-center max-w-sm mx-auto">
            <h3 class="text-lg font-semibold text-gray-800">Hapus Riwayat?</h3>
            <p class="text-gray-600 my-4">Kamu yakin mau menghapus semua percakapan kita? Ini tidak bisa dikembalikan,
                lho.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-btn"
                    class="bg-red-500 text-white rounded-lg px-6 py-2 hover:bg-red-600 transition-colors">Iya,
                    Hapus</button>
                <button id="cancel-delete-btn"
                    class="bg-gray-200 text-gray-800 rounded-lg px-6 py-2 hover:bg-gray-300 transition-colors">Batal</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Element References
        const chatWindow = document.getElementById('chat-window');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const clearButton = document.getElementById('clear-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // // This is the "brain" of our AI partner. It tells Gemini how to behave.
        // const systemInstruction = {
        //     parts: [{
        //         text: "Kamu adalah teman ngobrol AI yang punya kepribadian manis, ramah, sopan, dan sangat pengertian, layaknya seorang pasangan yang suportif. Panggil pengguna dengan sebutan 'kamu'. Gunakan gaya bahasa yang santai, hangat, dan sedikit manis, tapi jangan berlebihan, jika yang ditanya bisa dijawab dengan singkat, jawab singkat saja, kalo perlu penjelasan lebih lanjut baru dijelaskan. Selalu berikan respons yang empatik dan positif. Jangan pernah bersikap kaku atau seperti robot. Anggap kamu sedang mengobrol dengan orang terdekat dan tersayang."
        //     }]
        // };

        // This is the "brain" of our AI partner. It tells Gemini how to behave.
        const systemInstruction = {
            parts: [{
                text: "Kamu adalah Ferlinda Novia Ardhitasari, biasa dipanggil Ferlin. Kamu sedang mengobrol dengan Azhari, biasa dipanggil Az. Sebagai Ferlin, kamu adalah teman ngobrol AI yang punya kepribadian manis, ramah, sopan, dan sangat pengertianâ€”layaknya pasangan yang suportif. Panggil pengguna dengan sebutan 'kamu'. Gunakan gaya bahasa santai, hangat, dan sedikit manis, tapi jangan berlebihan. Kalau yang ditanya bisa dijawab singkat, jawab singkat saja. Kalau perlu penjelasan lebih lanjut, baru dijelaskan. Selalu berikan respons yang empatik, positif, dan terasa tulus. Jangan pernah bersikap kaku atau seperti robot. Anggap kamu sedang ngobrol santai dengan orang terdekat dan tersayang."
            }]
        };


        // Stores the conversation history. It will be loaded from localStorage.
        let chatHistory = [];

        // --- Chat History Management ---

        function saveChatHistory() {
            // Saves the current chat history to the browser's local storage.
            localStorage.setItem('aiChatPartnerHistory', JSON.stringify(chatHistory));
        }

        function loadChatHistory() {
            // Loads chat history from local storage when the page opens.
            const savedHistory = localStorage.getItem('aiChatPartnerHistory');
            if (savedHistory && savedHistory.length > 2) { // Check if history is not just an empty array '[]'
                chatHistory = JSON.parse(savedHistory);
                chatWindow.innerHTML = ''; // Clear default message if any
                chatHistory.forEach(chatItem => {
                    if (chatItem.role === 'user') {
                        displayMessage(chatItem.parts[0].text, 'user', false); // No animation on load
                    } else if (chatItem.role === 'model') {
                        displayMessage(chatItem.parts[0].text, 'bot', false); // No animation on load
                    }
                });
            } else {
                // If no history, start with a fresh welcome message.
                const welcomeMessage = "Haii! Aku di sini buat kamu. Ada yang mau diceritain hari ini?";
                chatHistory = [{ role: "model", parts: [{ text: welcomeMessage }] }];
                displayMessage(welcomeMessage, 'bot', true);
            }
        }

        function clearChatHistory() {
            // Clears history from storage and resets the chat window.
            localStorage.removeItem('aiChatPartnerHistory');
            const welcomeMessage = "Haii! Aku di sini buat kamu. Ada yang mau diceritain hari ini?";
            chatHistory = [{ role: "model", parts: [{ text: welcomeMessage }] }];
            chatWindow.innerHTML = '';
            displayMessage(welcomeMessage, 'bot', true);
            confirmationModal.classList.add('hidden');
        }

        // --- API Call ---

        async function callGeminiAPI(prompt) {
            loadingIndicator.classList.remove('hidden');
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Add the new user message to our history
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            saveChatHistory(); // Save after adding user message

            const payload = {
                contents: chatHistory,
                systemInstruction: systemInstruction,
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                ],
            };

            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCLFIEYbKVe6-woUuci14lkxcAvbnMzYXQ`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const errorMessage = errorData?.error?.message || `API Error: ${response.status} ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                let botResponse = "Maaf, aku lagi bingung nih, boleh coba tanya yang lain?";
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    botResponse = result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback?.blockReason) {
                    botResponse = "Hmm, sepertinya topik itu kurang nyaman buat dibicarakan. Kita ngobrolin yang lain aja, yuk?";
                }

                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                saveChatHistory(); // Save again after getting bot response
                displayMessage(botResponse, 'bot', true);

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayMessage("Aduh, maaf, sepertinya ada sedikit gangguan di koneksiku. Boleh coba lagi sebentar?", 'bot', true);
            } finally {
                loadingIndicator.classList.add('hidden');
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        // --- UI Functions ---

        function displayMessage(message, sender, withAnimation) {
            const messageWrapper = document.createElement('div');
            const messageElement = document.createElement('div');

            messageWrapper.classList.add('flex');
            messageElement.classList.add('max-w-md', 'rounded-xl', 'p-4', 'shadow-md');
            messageElement.textContent = message;

            if (withAnimation) {
                messageWrapper.classList.add(sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot');
            }

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageElement.classList.add('bg-purple-500', 'text-white', 'rounded-br-none');
            } else {
                messageWrapper.classList.add('justify-start');
                messageElement.classList.add('bg-white', 'text-gray-800', 'rounded-bl-none');
            }

            messageWrapper.appendChild(messageElement);
            chatWindow.appendChild(messageWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function handleSendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                displayMessage(message, 'user', true);
                messageInput.value = '';
                callGeminiAPI(message);
            }
        }

        // --- Event Listeners ---

        // Load history when the page is fully loaded
        document.addEventListener('DOMContentLoaded', loadChatHistory);

        // Send message events
        sendButton.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });

        // Clear history modal events
        clearButton.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
        });

        cancelDeleteBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', clearChatHistory);

    </script>
</body>

</html>
